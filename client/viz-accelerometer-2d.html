<!DOCTYPE html>
<html lang="en">
  <head>
    <title>2d accelerometer viz</title>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, minimum-scale=1.0, maximum-scale=1.0"
    />
    <style>
      .highcharts-figure,
      .highcharts-data-table table {
        min-width: 360px;
        max-width: 800px;
        margin: 1em auto;
      }

      .highcharts-data-table table {
        font-family: Verdana, sans-serif;
        border-collapse: collapse;
        border: 1px solid #ebebeb;
        margin: 10px auto;
        text-align: center;
        width: 100%;
        max-width: 500px;
      }

      .highcharts-data-table caption {
        padding: 1em 0;
        font-size: 1.2em;
        color: #555;
      }

      .highcharts-data-table th {
        font-weight: 600;
        padding: 0.5em;
      }

      .highcharts-data-table td,
      .highcharts-data-table th,
      .highcharts-data-table caption {
        padding: 0.5em;
      }

      .highcharts-data-table thead tr,
      .highcharts-data-table tr:nth-child(even) {
        background: #f8f8f8;
      }

      .highcharts-data-table tr:hover {
        background: #f1f7ff;
      }
    </style>
  </head>

  <body>
    <div id="container"></div>
    <div id="info">visualizing acceleration in 2d</div>

    <script src="https://code.highcharts.com/highcharts.js"></script>
    <script src="https://code.highcharts.com/modules/series-label.js"></script>
    <script src="https://code.highcharts.com/modules/exporting.js"></script>
    <script src="https://code.highcharts.com/modules/export-data.js"></script>
    <script src="https://code.highcharts.com/modules/accessibility.js"></script>

    <figure class="highcharts-figure">
      <div id="container"></div>
      <p class="highcharts-description">
        Basic line chart showing trends in a dataset. This chart includes the
        <code>series-label</code> module, which adds a label to each line for
        enhanced readability.
      </p>
    </figure>

    <script src="./node_modules/tone/build/Tone.js"></script>
    <script src="./node_modules/socket.io/client-dist/socket.io.js"></script>
    <script type="module">
      import { socket, syncClient } from "./lib/sync-socket.js";

      Highcharts.chart("container", {
        title: {
          text: "accelerometer xyz",
          align: "left",
        },

        subtitle: {
          text: 'just one device at a time for testing',
          align: "left",
        },

        yAxis: {
          title: {
            text: "m/s^2",
          },
        },

        xAxis: {
          accessibility: {
            rangeDescription: "Range: 2010 to 2020",
          },
        },

        legend: {
          layout: "vertical",
          align: "right",
          verticalAlign: "middle",
        },

        plotOptions: {
          series: {
            label: {
              connectorAllowed: false,
            },
            pointStart: 2010,
          },
        },

        series: [
          {
            name: "acceleration x",
            data: [
              43934, 48656, 65165, 81827, 112143, 142383, 171533, 165174,
              155157, 161454, 154610,
            ],
          },
          {
            name: "acceleration y",
            data: [
              24916, 37941, 29742, 29851, 32490, 30282, 38121, 36885, 33726,
              34243, 31050,
            ],
          },
          {
            name: "acceleration z",
            data: [
              11744, 30000, 16005, 19771, 20185, 24377, 32147, 30912, 29243,
              29213, 25663,
            ],
          },
        ],

        responsive: {
          rules: [
            {
              condition: {
                maxWidth: 500,
              },
              chartOptions: {
                legend: {
                  layout: "horizontal",
                  align: "center",
                  verticalAlign: "bottom",
                },
              },
            },
          ],
        },
      });

      let lines = [];

      function init() {
        socket.on("movementEvents", (movementEvents) => {
          console.log("movementEvents on client", movementEvents);

          // remove old lines
          lines.forEach((line) => {
            scene.remove(line);
            line.geometry.dispose();
          });
          lines = [];

          Object.entries(movementEvents).map(([clientId, events]) => {
            // this is a very hacky deterministic way to get a hex code from a guid
            const hexFromGuid = `#${clientId.substring(0, 6)}`;
            const material = new THREE.LineBasicMaterial({
              color: hexFromGuid,
            });

            const points = [];
            events.forEach((event) => {
              points.push(
                new THREE.Vector3(event.motionX, event.motionY, event.motionZ)
              );
            });

            const geometry = new THREE.BufferGeometry().setFromPoints(points);
            const line = new THREE.Line(geometry, material);

            lines.push(line);
            scene.add(line);
          });
        });
      }
    </script>
  </body>
</html>
