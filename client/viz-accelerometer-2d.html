<!DOCTYPE html>
<html lang="en">
  <head>
    <title>2d accelerometer viz</title>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, minimum-scale=1.0, maximum-scale=1.0"
    />
    <style>
      .highcharts-figure,
      .highcharts-data-table table {
        min-width: 360px;
        max-width: 800px;
        margin: 1em auto;
      }

      .highcharts-data-table table {
        font-family: Verdana, sans-serif;
        border-collapse: collapse;
        border: 1px solid #ebebeb;
        margin: 10px auto;
        text-align: center;
        width: 100%;
        max-width: 500px;
      }

      .highcharts-data-table caption {
        padding: 1em 0;
        font-size: 1.2em;
        color: #555;
      }

      .highcharts-data-table th {
        font-weight: 600;
        padding: 0.5em;
      }

      .highcharts-data-table td,
      .highcharts-data-table th,
      .highcharts-data-table caption {
        padding: 0.5em;
      }

      .highcharts-data-table thead tr,
      .highcharts-data-table tr:nth-child(even) {
        background: #f8f8f8;
      }

      .highcharts-data-table tr:hover {
        background: #f1f7ff;
      }
    </style>
  </head>

  <body>
    <div id="container"></div>
    <div id="info">visualizing acceleration in 2d</div>

    <script src="https://code.highcharts.com/highcharts.js"></script>
    <script src="https://code.highcharts.com/modules/exporting.js"></script>
    <script src="https://code.highcharts.com/modules/export-data.js"></script>
    <script src="https://code.highcharts.com/modules/accessibility.js"></script>

    <script src="./node_modules/tone/build/Tone.js"></script>
    <script src="./node_modules/socket.io/client-dist/socket.io.js"></script>
    <script type="module">
      import { socket, syncClient } from "./lib/sync-socket.js";

      const ACC_THRESHOLD = 3.0;

      // display utc timestamps in browser local
      Highcharts.setOptions({
        time: {
          useUTC: false,
        },
      });

      const chart = Highcharts.chart("container", {
        title: {
          text: "accelerometer xyz",
          align: "left",
        },

        subtitle: {
          text: "just one device at a time for testing",
          align: "left",
        },

        yAxis: {
          title: {
            text: "m/s^2",
          },
        },

        xAxis: {
          accessibility: {
            rangeDescription: "Range: 2010 to 2020",
          },
          labels: {
            format: "{value:%H:%M:%S.%L}",
          },
        },

        legend: {
          layout: "vertical",
          align: "right",
          verticalAlign: "middle",
        },

        series: [
          {
            name: "acceleration x",
            data: [],
          },
          {
            name: "acceleration y",
            data: [],
          },
          {
            name: "acceleration z",
            data: [],
          },
        ],

        responsive: {
          rules: [
            {
              condition: {
                maxWidth: 500,
              },
              chartOptions: {
                legend: {
                  layout: "horizontal",
                  align: "center",
                  verticalAlign: "bottom",
                },
              },
            },
          ],
        },
      });

      socket.on("movementEvents", (movementEvents) => {
        const eventsForFirstClientId = Object.values(movementEvents)[0];

        const xData = [];
        const yData = [];
        const zData = [];
        const timestampsOverThreshold = [];
        eventsForFirstClientId.forEach((event) => {
          xData.push([event.timestamp, event.motionX]);
          yData.push([event.timestamp, event.motionY]);
          zData.push([event.timestamp, event.motionZ]);

          if (
            event.motionX > ACC_THRESHOLD ||
            event.motionY > ACC_THRESHOLD ||
            event.motionZ > ACC_THRESHOLD
          ) {
            timestampsOverThreshold.push(event.timestamp);
          }
        });

        const firstEventTimestamp = eventsForFirstClientId[0].timestamp;

        chart.update({
          // plotOptions: { series: { pointStart: firstEventTimestamp } },
          xAxis: {
            plotLines: timestampsOverThreshold.map((timestamp) => ({
              color: "red",
              width: 2,
              value: timestamp,
            })),
          },
        });

        // this only works bc of the indices... not super robusto, fine for prototype
        chart.series[0].setData(xData);
        chart.series[1].setData(yData);
        chart.series[2].setData(zData);
      });
    </script>
  </body>
</html>
