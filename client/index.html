<html>
    <head>
        <title>spatial speaker</title>
        <meta name="viewport" content="width=device-width, initial-scale=1" />
    </head>
    <body>
        <h1>spatial speaker</h1>
        <button id="start">start</button>
        Local:<br />
        <h1 id="local"></h1>

        Server:<br />
        <h1 id="server"></h1>
        <h1 id="syncs">Sync History</h1>
        <table id="sync-table">
        </table>

        <h1>Stats</h1>
        Offset:  <span id="offset"></span> with best precision: <span id="precision"></span>

        <!-- <button id="stop">stop</button> -->
        <script src="./node_modules/tone/build/Tone.js"></script>
        <script src="./node_modules/socket.io/client-dist/socket.io.js"></script>
        <script src="/lib/gotime-master/GoTime.js"></script>
        <script type="module">
            const socket = io();

            GoTime.setOptions({
                AjaxURL: "/time",
                WhenSynced: updateSyncData, // Is called for the first sync
                OnSync: updateSyncData,// Calls on every sync starting with the second sync
                SyncInitialTimeouts: [500, 3000, 9000, 15000],
                SyncInterval: 20000 // Set this often for demo purposes only
            });

            // set up socket sync acknowledgement for GoTime
            GoTime.wsSend(() => {
                socket.emit("time", null, null, ({ serverTime }) => {
                    GoTime.wsReceived(serverTime);
                });
                return true;
            })

            function appendHistory(t, method, offset, precision) {
                const timestampCell = document.createElement("td");
                const methodCell = document.createElement("td");
                const offsetCell = document.createElement("td");
                const precisionCell = document.createElement("td");

                timestampCell.innerText = (new Date(t)).toLocaleTimeString();
                methodCell.innerText = method;
                offsetCell.innerText = `${offset}ms`;
                precisionCell.innerText = `${precision}ms`;

                const newRow = document.createElement("tr");
                newRow.appendChild(timestampCell);
                newRow.appendChild(methodCell);
                newRow.appendChild(offsetCell);
                newRow.appendChild(precisionCell);

                document.getElementById("sync-table").appendChild(newRow);
            }

            function updateSyncData(t, method, off, precision) {
                console.log(GoTime.getHistory());
                var local = new Date();
                var server = new GoTime();
                document.getElementById("local").innerText = local.getTime();
                document.getElementById("server").innerText = server.getTime();   
                document.getElementById("offset").innerText = GoTime.getOffset();
                document.getElementById("precision").innerText = GoTime.getPrecision();
                appendHistory(t, method, off, precision);
            }

            const getNow = () => performance.timeOrigin + performance.now();

            // wire up start and stop buttons
            document.getElementById("start").addEventListener('click', async () => {
                await Tone.start();
            })

            const wait = (ms) => new Promise(resolve => setTimeout(resolve, ms));

            const player = new Tone.Player("https://tonejs.github.io/audio/berklee/gong_1.mp3").toDestination();
            var sine = new Tone.Oscillator(440, "sine").toDestination();

            Tone.loaded().then(async() => {
                await wait(5000); // wait 5 secs for GoTime to sync up clocks before scheduling anything

                socket.on("gong", ({ serverTime }) => {
                    console.log("received gong event");

                    const offsetSeconds = GoTime.getOffset() / 1000;
                    const toneNow = Tone.now();

                    // account for network offset twice: once in received message delay, once in clock offset
                    const timeToPlay = Tone.now() + 0.25 - (offsetSeconds * 2);
                    console.log("timeToPlay", timeToPlay);

                    player.start(timeToPlay);
                });
            });
        </script>
    </body>
</html>