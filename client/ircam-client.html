<html>
    <head>
        <title>ircam client</title>
        <meta name="viewport" content="width=device-width, initial-scale=1" />
    </head>
    <body>
        <h1>spatial speaker</h1>
        <button id="start">start</button>


        <script src="./node_modules/tone/build/Tone.js"></script>
        <!-- <script src="./node_modules/@ircam/sync"></script> -->
        <script src="./node_modules/socket.io/client-dist/socket.io.js"></script>
        <script type="module">
            import SyncClient from "./lib/ircam-client-converted.js";
            const socket = io();

            // return the local time in seconds
            const getTimeFunction = () => performance.now() / 1000;

            // init sync client
            const syncClient = new SyncClient(getTimeFunction);

            socket.on("connect", () => {
                const sendFunction = (pingId, clientPingTime) => {
                    socket.emit("ircam", { isPing: true, pingId, clientPingTime });
                };

                const receiveFunction = callback => {
                    socket.on("ircam", ({ isPing, pingId, clientPingTime, serverPingTime, serverPongTime }) => {
                        if (!isPing) {
                            callback(pingId, clientPingTime, serverPingTime, serverPongTime);
                        }
                    });
                };

                // check the synchronization status, when this function is called for the 
                // first time, you can consider the synchronization process properly 
                // initiated.
                const statusFunction = status => console.log(status);
                // start synchronization process
                syncClient.start(sendFunction, receiveFunction, statusFunction);
            });
    

            // monitor the synchronized clock
            setInterval(() => {
                const syncTime = syncClient.getSyncTime();
                console.log(syncTime);
            }, 100);

        </script>
    </body>
</html>